name: Playwright BDD Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    # 📥 Checkout the repository
    - name: 📥 Checkout repo
      uses: actions/checkout@v3

    # 🐳 Set up Docker Buildx for building container images
    - name: 🐳 Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 🛠️ Build Docker image for Playwright BDD tests
    - name: 🛠️ Build Docker image
      run: docker build -t playwright-bdd-tests .

    # 🧹 Clean up allure-results folder on host to avoid stale files
    - name: 🧹 Clean allure-results folder
      run: |
        rm -rf allure-results
        mkdir -p allure-results

    # 🧪 Run BDD Tests in Docker
    - name: 🧪 Run BDD Tests in Docker
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/allure-results:/app/allure-results \
          playwright-bdd-tests

    # 📤 Upload Allure results as a CI/CD artifact
    - name: 📤 Upload Allure Results (artifact)
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: allure-results

    # 📊 (Optional) Generate and Upload Allure HTML Report
    - name: 📊 Generate Allure Report
      uses: simple-elf/allure-report-action@v1
      with:
        results-directory: allure-results
        report-directory: allure-report

    - name: 📤 Upload Allure Report (HTML)
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report
